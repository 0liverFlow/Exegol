name: Nightly build

on:
  push:
    branches:
      - "cicd"
    paths-ignore:
      # - ".github/**"
      - "*.md"

jobs:
  testing:
    name: Code testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          submodules: false
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install requirements
        run: python -m pip install --user mypy types-requests types-PyYAML
      - name: Run code analysis
        run: mypy ./exegol/ --ignore-missing-imports --check-untyped-defs --pretty # TODO add --disallow-untyped-defs

  compatibility:
    name: Compatibility checks
    runs-on: ubuntu-latest
    needs: testing
    strategy:
      fail-fast: false
      matrix:
        version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
        os: [win32, linux, darwin]
    steps:
      - uses: actions/checkout@master
        with:
          submodules: false
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install requirements
        run: python -m pip install --user mypy types-requests types-PyYAML
      - name: Check python compatibility for ${{ matrix.os }}/${{ matrix.version }}
        run: mypy ./exegol.py --ignore-missing-imports --check-untyped-defs --python-version ${{ matrix.version }} --platform ${{ matrix.os }}

  build-n-publish:
    name: Build and publish Python üêç distributions to TestPyPI üì¶
    runs-on: ubuntu-latest
    needs: compatibility
    steps:
      - uses: actions/checkout@master
        with:
          submodules: true
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install requirements
        run: python -m pip install --user build
      - name: Cleaning
        run : python setup.py clean
      - name: Build Exegol
        run: python -m build --sdist --outdir dist/ .
      - name: Publish distribution üì¶ to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/
          skip_existing: true
